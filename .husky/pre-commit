#!/bin/sh

# Set up Node.js environment for Git Bash/mingw64
export PATH="/c/Program Files/nodejs:$PATH"
export PATH="/c/Users/Igor Cogo Koehler/AppData/Roaming/npm:$PATH"

echo "🧪 EVIDENS TDD Protocol: Enforcing test requirements..."

# Run lint-staged using local installation
if [ -f "./node_modules/.bin/lint-staged" ]; then
    ./node_modules/.bin/lint-staged
else
    echo "⚠️ lint-staged not found, skipping..."
fi

echo "🔍 Checking TypeScript compilation..."
echo "Node version: $(node --version 2>/dev/null || echo 'Node not found')"
echo "NPM version: $('/c/Program Files/nodejs/npm.cmd' --version 2>/dev/null || echo 'NPM not found')"

# Use local TypeScript installation
if [ -f "./node_modules/.bin/tsc" ]; then
    echo "Using local TypeScript..."
    ./node_modules/.bin/tsc --noEmit
else
    echo "TypeScript not found locally"
    exit 1
fi

if [ $? -ne 0 ]; then
    echo "❌ TypeScript compilation failed. Fix errors before committing."
    exit 1
fi

echo "🧪 Running complete test suite..."
echo "📋 TDD Protocol: ALL tests must pass before committing."

# Run tests using local installation
if [ -f "./node_modules/.bin/vitest" ]; then
    ./node_modules/.bin/vitest run
else
    echo "Vitest not found locally"
    exit 1
fi

if [ $? -ne 0 ]; then
    echo "❌ Tests failed. Fix failing tests before committing."
    echo "📋 TDD Protocol violation: Cannot commit with failing tests."
    exit 1
fi

echo "✅ All TDD Protocol checks passed!"
echo "🚀 Commit approved - TDD Protocol compliance verified."
name: Deploy Edge Functions Only

on:
  push:
    branches: [main]
    paths:
      - 'supabase/functions/**'
      - '.github/workflows/deploy-supabase.yml'
  workflow_dispatch:

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions Only
        run: |
          echo "ðŸš€ Skipping migrations, deploying Edge Functions only..."
          echo "Database schema is already in sync from previous db pull"
          echo ""
          
          # Deploy functions one by one with error handling
          functions_to_deploy=(
            "admin-tag-analytics"
            "admin-tag-operations" 
            "admin-manage-users"
            "get-community-page-data"
            "get-acervo-data"
            "cast-vote"
          )
          
          for function_name in "${functions_to_deploy[@]}"; do
            echo "ðŸ“¦ Deploying $function_name..."
            if supabase functions deploy $function_name --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --verify-jwt=false; then
              echo "âœ… Successfully deployed $function_name"
            else
              echo "âŒ Failed to deploy $function_name"
              echo "Continuing with next function..."
            fi
          done
          
          echo "ðŸŽ‰ Edge Function deployment completed!"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Edge Functions Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Deployed Functions:" >> $GITHUB_STEP_SUMMARY
          echo "- admin-tag-analytics" >> $GITHUB_STEP_SUMMARY
          echo "- admin-tag-operations" >> $GITHUB_STEP_SUMMARY
          echo "- admin-manage-users" >> $GITHUB_STEP_SUMMARY
          echo "- get-community-page-data" >> $GITHUB_STEP_SUMMARY
          echo "- get-acervo-data" >> $GITHUB_STEP_SUMMARY
          echo "- cast-vote" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Expected Fixes:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Resolve 503 Service Unavailable errors" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Admin panels should load correctly" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Voting system should work with immediate feedback" >> $GITHUB_STEP_SUMMARY
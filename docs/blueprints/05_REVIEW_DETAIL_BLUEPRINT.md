\[Blueprint\] 05: Review Detail Page  
Version: 2.0  
Date: June 14, 2025  
Purpose: This document defines the complete architecture for the Review Detail Page (\`/reviews/\[slug\]\`), the core reading experience of the EVIDENS platform. This blueprint details how to render the complex, custom layouts generated by the Visual Composition Engine.

\================================================================================  
1.0. Purpose & User Experience  
\================================================================================

1.1. Feature Goal  
To present a published Review in a clean, focused, "editorial feel" reading environment that is both beautiful and performant. It must faithfully render the custom layouts created in the editor and seamlessly integrate community interaction.

1.2. Core User Stories  
\*   "As a Practitioner, I want to read a Review without any distractions so I can focus on the content."  
\*   "As a Practitioner, I want to see the custom diagrams and layouts as the author intended, to better understand the concepts."  
\*   "As a Practitioner, I want to seamlessly transition from reading the Review to seeing what the community is saying about it."

\================================================================================  
2.0. Visual & Interaction Blueprint  
\================================================================================

1\.  Header: Displays the Review's \`title\`, \`author\` information, and \`published\_at\` date.  
2\.  Content Body: This is the main section. It renders the \`structured\_content\` from the database. It is NOT a simple vertical list of blocks. It is a canvas that uses the \`layouts\` object to position content blocks on a grid, creating the custom visual design.  
3\.  Collapsible Sections: Any \`HeadingBlock\` marked as \`isCollapsible\` will have a toggle icon. Clicking it will expand or collapse all content blocks nested under it until the next heading of the same or higher level.  
4\.  Community Thread: Below the main content body, a dedicated section for the associated community discussion.  
    \*   Interaction: This section MUST be lazy-loaded. It should display a skeleton loader initially and only fetch/render the comments when it is about to enter the user's viewport.  
5\.  Recommended Section: Below the community thread, a section titled "Leituras recomendadas" displays cards for 4 other recommended reviews and 1 video card for the course.

\================================================================================  
3.0. Front-End Architecture: The Layout-Aware Renderer  
\================================================================================

This page's architecture is centered around a new recursive rendering engine.

\*   \`ReviewDetailPage.js\` (Page Component):  
    \*   Responsibility: Fetches the required data for a specific review using the \`useReviewQuery\` hook. Handles loading and error states.  
    \*   Props: Receives \`slug\` from the URL.  
    \*   Renders: Passes the fetched \`review\` object to \`LayoutAwareRenderer\`.

\*   \`LayoutAwareRenderer.js\`:  
    \*   Responsibility: The core of the new rendering logic.  
    \*   Props: \`{ content: structuredContentV2Object }\`  
    \*   Logic:  
        1\.  Detects the current viewport (e.g., using a \`useMediaQuery\` hook).  
        2\.  Selects the appropriate layout array from \`props.content.layouts\` (\`desktop\` or \`mobile\`).  
        3\.  Renders a container element styled with \`display: grid\`.  
        4\.  Maps over the \`props.content.nodes\` array. For each \`node\`, it finds the corresponding layout object from the selected layout array (matching by \`id\`).  
        5\.  It then renders a \`BlockRenderer\` component, passing the \`node\` and its specific \`layout\` info as props.

\*   \`BlockRenderer.js\`:  
    \*   Responsibility: A controller component that selects the correct presentational component for a given block type.  
    \*   Props: \`{ node: NodeObject, layout: LayoutObject }\`  
    \*   Logic:  
        1\.  Renders a wrapper \`div\` and applies the grid positioning styles from \`props.layout\` (\`grid-column\`, \`grid-row\`).  
        2\.  Uses a \`switch\` statement on \`props.node.type\` to render the specific block component (\`HeadingBlock\`, \`TextBlock\`, \`ImageBlock\`, etc.), passing the \`node.data\` down as props.

\*   Specific Block Components (\`TextBlock.js\`, \`ImageBlock.js\`, \`DiagramBlock.js\`, etc.):  
    \*   Responsibility: Dumb presentational components responsible for rendering the final HTML for a single block type. They receive their content from props and have no other logic.

\================================================================================  
4.0. Backend & Data Flow  
\================================================================================

\*   Primary Data Fetch:  
    \*   Hook: \`useReviewQuery(slug)\`  
    \*   Underlying Call: \`supabase.from('Reviews').select('\*, author:Practitioners(\*)').eq('slug', slug).single()\`  
    \*   Returns: A single \`Review\` object, including the all-important \`structured\_content\` v2.0 object.  
\*   Lazy-Loaded Data:  
    \*   Hook: \`useCommunityThreadQuery(postId)\`  
    \*   Purpose: Fetches the comments for the associated community post. This hook will use \`useInfiniteQuery\` for pagination.  
    \*   Trigger: Called by an intersection observer when the comments section is scrolled into view.  
\*   Recommendations Data:  
    \*   Hook: \`useRecommendationsQuery(reviewId)\`  
    \*   Underlying Call: Invokes the \`get-review-recommendations\` Edge Function.

\================================================================================  
5.0. Implementation Checklist  
\================================================================================

1\.  \[ \] Data Layer: Create the \`useReviewQuery\` hook.  
2\.  \[ \] Component Skeleton: Build the \`ReviewDetailPage.js\` component to handle loading/error states.  
3\.  \[ \] Renderer Core: Build the \`LayoutAwareRenderer.js\` and \`BlockRenderer.js\` components with their core logic (viewport detection, grid rendering, switch statement).  
4\.  \[ \] Basic Blocks: Implement the \`TextBlock.js\` and \`HeadingBlock.js\` components.  
5\.  \[ \] Advanced Blocks: Implement the \`ImageBlock.js\` and \`DiagramBlock.js\`.  
6\.  \[ \] Collapsible Logic: Add state and toggle logic to the \`HeadingBlock.js\` component.  
7\.  \[ \] Lazy Loading: Implement the intersection observer and the \`useCommunityThreadQuery\` hook to lazy-load the comments section.  
8\.  \[ \] Recommendations: Implement the \`useRecommendationsQuery\` hook and the final \`RecommendedSection.js\` component.  
9\.  \[ \] Styling: Apply final styling from \`\[DOC\_7\]\` to all components for the "editorial feel."

